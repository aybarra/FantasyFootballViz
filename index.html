<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Fantasy Football Test</title>

    <script src="d3/d3.js"></script>
    <script src="crossfilter/crossfilter.min.js" type="text/javascript"></script>
    <script src="dc/dc.min.js" type="text/javascript"></script>
    <script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/datatables.min.js" type="text/javascript"></script>
    <script src="js/filter_grouping.js"></script>
    <script src="js/model/FilterObject.js"></script>

    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="dc/dc.css" rel="stylesheet" type="text/css">
    <link href="css/dashboard.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
    <link href="css/datatables.min.css" rel="stylesheet">

</head>

<body>

<!-- Create Navigation Bar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid ">
        <div id="navbar">
            <a class="navbar-brand" id="menu-trigger"
               style="cursor:pointer; -webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;">Filter</a>

            <p class="navbar-brand nav navbar-nav navbar-right" id="title">Armchair Fantasy Football</p>
        </div>
    </div>
</nav>

<!--Sliding Menu-->
<div id="menu"
     style="width: 600px; z-index: 1; display: none; position:fixed; background-color: #b0c4de; height: 100%; padding-left: 20px">
    <div class="row" id="panel">
        <div id="filters">
            <!-- Year Chart DIV-->
            <div class="col-md-10" id="filter_years">
                <h4>Year Range</h4>
            </div>
            <!-- Date Chart DIV-->
            <div class="col-md-10" id="filter_dates" style=" clear:both;">
                <h4>Point Range</h4>
            </div>
            <!-- Checkbox DIV-->
            <div class="col-md-10" id="filter_position" style=" clear:both;">
                <h4>Positions</h4>
                <label>
                    <input type=checkbox name="running_back" value="running_back" id="filter_running_back"/>
                    Running Back
                </label>
                <label>
                    <input type=checkbox name="quarter_back" value="quarter_back" id="filter_quarter_back"/>
                    Quarter Back
                </label>
                <label>
                    <input type=checkbox name="wr_te" value="wr_te" id="filter_wr_te"/>
                    WR/TE
                </label>

            </div>
            <div id="filter_info_div" style=" clear:both;"></div>
            <div id="apply_filter_div">
                <button id="clear_filter_button">Clear Filter</button>
                <button id="add_filter_button">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Create The Dashboard -->
<div class="container-fluid" style="z-index: 0; position: relative;">

    <!-- Create Chart Display Areas -->
    <div class="col-sm-12 main">
        <div class="row">
            <div class="col-sm-2" id="filter-section">
                <h4>Filter Section</h4>
                <table id="filters_table">
                </table>
            </div>
            <div class="col-sm-7" id="large-section">
                <h4>Large Section</h4>
            </div>
            <div class="col-sm-3">
                <h4>Player Data Table</h4>
                <table class="table table-striped table-borderedr" id="data_table">
                    <thead>
                    <tr class="header">
                        <th>Name</th>
                        <!--<th>Year</th>-->
                        <th>Fantasy Points</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>

        <div class="row" style="display: none;">
            <div class="col-md-6" id="box-whisker-chart">
                <h4>Box and Whisker Plot</h4>
            </div>
            <div class="col-md-6" id="histogram">
                <h4>Histogram</h4>
            </div>
        </div>

    </div>
</div>

<script>

    //Global variable used to hold array list of filter objects
    var filterObjects = [];

    //Add Default Filter
    filterObjects.push( new FilterObject( 2000, 2015, null, null, null ) );

    //Draw the current filter table with the default filter applied.
    drawCurrentFilterTable();

    //Variable to hold the state of the sliding menu
    var isMenuOpen = false;

    //Initialize the sliding drawer for the filters.
    $( "#menu-trigger" ).click( function ()
    {
        //If open -- close, if closed -- open
        if( isMenuOpen )
        {
            $( "#menu" ).css( {
                "display": "none"
            } );
        }
        else
        {
            $( "#menu" ).css( {
                "display": "block"
            } );
        }
        isMenuOpen = !isMenuOpen;
    } );

    var yearFormat = d3.time.format( '%Y' );

    var box_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var box_width = 500// - box_margin.left - box_margin.right;
    var box_height = 150// - box_margin.top - box_margin.bottom;
    var box_chart = dc.boxPlot( "#box-whisker-chart" );

    var scatter_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var scatter_width = 1000;
    var scatter_height = 500;
    var scatter_chart = dc.scatterPlot( "#large-section" );

    var hist_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var hist_width = 500;
    var hist_height = 150;
    var hist_chart = dc.barChart( "#histogram" );

    //Initial Ajax call to load data.
    $.ajax( {
        url: 'http://localhost:8000/careers/',
        type: 'GET',
        data: {
            format: 'json'
        },
        error: function ()
        {
            console.log( "Error Loading Data." )
        },
        success: function ( data )
        {
            //Get the array of player data from the JSON response
            data = data[ 'results' ];

            data.forEach( function ( x )
            {
                x.short_year = x.start_year;
                x.year = yearFormat.parse( x.start_year + "" );
                x.name = x.player_name;
                x.fantPt = +x.ff_pts;
                x.winPct = +x.win_pct * 100;
            } );

            var ndx = crossfilter( data );

            var box_dimension = ndx.dimension( function ( d )
            {
                return new Date( new Date( d.year ).setDate( 1 ) );
            } );
            var box_group = box_dimension.group().reduce(
                    function ( p, v )
                    {
                        p.push( v.fantPt );
                        return p;
                    },
                    function ( p, v )
                    {
                        p.splice( p.indexOf( v.fantPt ), 1 );
                        return p;
                    },
                    function ()
                    {
                        return [];
                    }
            );

            box_chart
                    .width( box_width )
                    .height( box_height )
                    .margins( box_margin )
                    .dimension( box_dimension )
                    .group( box_group )
                    .boxWidth( 3 )
                    .colors( "red" )
                    .x( d3.time.scale().domain( [ new Date( "1918" ), new Date( "2016" ) ] ) )
                    .round( d3.time.year.round )
                    .xUnits( d3.time.year )
                    .yAxisLabel( "Fantasy Points" )
                    .xAxisLabel( "Year" )
                    .elasticY( true )
                    .elasticX( true )
                    .keyAccessor( function ( d )
                    {
                        return d.key;
                    } )
                    .valueAccessor( function ( d )
                    {
                        return d.value;
                    } )
                    .on( "renderlet", function ( box_chart )
                    {

                        var gBoxLabels = box_chart.selectAll( "text.box" );
                        var gWhiskLabels = box_chart.selectAll( "text.whisker" );
                        gBoxLabels.remove();
                        gWhiskLabels.remove();

                    } );

            var scatterDimension = ndx.dimension( function ( d )
            {
                return [ d.winPct, d.fantPt ];
            } );
            var scatterGroup = scatterDimension.group();

            scatter_chart
                    .width( scatter_width )
                    .height( scatter_height )
                    .margins( scatter_margin )
                    .symbolSize( 8 )
                    .clipPadding( 10 )
                    .mouseZoomable( true )
                    .x( d3.scale.linear().domain( [ 0, 100 ] ) )
                    .dimension( scatterDimension )
                    .group( scatterGroup )
                //.brushOn( false )
                    .renderTitle( true )
                    .title( function ( p )
                    {
                        return
                        d.name;
                    } )
                    .yAxisLabel( "Fantasy Points" )
                    .xAxisLabel( "Win Percentage" )
                    .xAxisPadding( 10 );

            var histDimension = ndx.dimension( function ( d )
            {
                return d.fantPt;
            } );
            var histGroup = histDimension.group().reduceCount();

            hist_chart
                    .width( hist_width )
                    .height( hist_height )
                    .margins( hist_margin )
                    .x( d3.scale.linear().domain( [ 0, 2550 ] ) )
                    .dimension( histDimension )
                    .group( histGroup )
                    .yAxisLabel( "Number of Players" )
                    .xAxisLabel( "Fantasy Points" );

            var table_dimension = ndx.dimension( function ( d )
            {
                return d.name;
            } );

            var data_table = $( "#data_table" ).dataTable( {
                "bPaginate": true,
                "pagingType": "full_numbers",
                "bLengthChange": false,
                "bFilter": false,
                "bSort": true,
                "bInfo": false,
                "bAutoWidth": false,
                "bDeferRender": true,
                "aaData": table_dimension.top( Infinity ),
                "bDestroy": true,
                "aoColumns": [
                    { "mData": "name", "sDefaultContent": "" },
                    { "mData": "fantPt", "sDefaultContent": " " }
                ]
            } );
//          { "mData": "short_year", "sDefaultContent": " " },

            function RefreshTable()
            {
                dc.events.trigger( function ()
                {
                    alldata = table_dimension.top( Infinity );
                    data_table.fnClearTable();
                    data_table.fnAddData( alldata );
                    data_table.fnDraw();
                } );
            }

            for ( var i = 0; i < dc.chartRegistry.list().length; i++ )
            {
                var chartI = dc.chartRegistry.list()[ i ];
                chartI.on( "filtered", RefreshTable );
            }

            dc.renderAll();
        }
    } );

    drawSelectionFilter();

</script>

</body>
</html>
