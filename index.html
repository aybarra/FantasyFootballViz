<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Fantasy Football Test</title>

    <script src="d3/d3.js"></script>
    <script src="crossfilter/crossfilter.min.js" type="text/javascript"></script>
    <script src="dc/dc.min.js" type="text/javascript"></script>
    <script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/datatables.min.js" type="text/javascript"></script>
    <script src="js/filter_grouping.js"></script>
    <script src="js/model/FilterObject.js"></script>
    <script src="js/lasso.js"></script>


    <script src="nvd3/build/nv.d3.min.js"></script>
    <script src="nvd3/src/tooltip.js"></script>
    <script src="nvd3/src/utils.js"></script>
    <script src="nvd3/src/models/legend.js"></script>
    <script src="nvd3/src/models/axis.js"></script>
    <script src="nvd3/src/models/distribution.js"></script>
    <script src="nvd3/src/models/scatter.js"></script>
    <script src="nvd3/src/models/scatterChart.js"></script>
    <link href="nvd3/build/nv.d3.min.css" rel="stylesheet">
    <script src="js/cdf.js"></script>

    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="dc/dc.css" rel="stylesheet" type="text/css">
    <link href="css/dashboard.css" rel="stylesheet">
    <link href="css/layout.css" rel="stylesheet">
    <link href="css/datatables.min.css" rel="stylesheet">

</head>

<body>

<!-- Create Navigation Bar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid ">
        <div id="navbar">
            <a class="navbar-brand" id="menu-trigger"
               style="cursor:pointer; -webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;">Filter</a>

            <p class="navbar-brand nav navbar-nav navbar-right" id="title">Armchair Fantasy Football</p>
        </div>
    </div>
</nav>

<!--Sliding Menu-->
<div id="menu"
     style="width: 600px; z-index: 1; display: none; position:fixed; background-color: #b0c4de; height: 100%; padding-left: 20px">
    <div class="row" id="panel">
        <div id="filters">
            <!-- Year Chart DIV-->
            <div class="col-md-10" id="filter_years">
                <h4>Year Range</h4>
            </div>
            <!-- Date Chart DIV-->
            <div class="col-md-10" id="filter_dates" style=" clear:both;">
                <h4>Point Range</h4>
            </div>
            <!-- Checkbox DIV-->
            <div class="col-md-10" id="filter_position" style=" clear:both;">
                <h4>Positions</h4>
                <label>
                    <input type=checkbox name="running_back" value="running_back" id="filter_running_back"/>
                    Running Back
                </label>
                <label>
                    <input type=checkbox name="quarter_back" value="quarter_back" id="filter_quarter_back"/>
                    Quarter Back
                </label>
                <label>
                    <input type=checkbox name="wr" value="wr" id="filter_wr"/>
                    WR
                </label>
                <label>
                    <input type=checkbox name="te" value="te" id="filter_te"/>
                    TE
                </label>

            </div>
            <div id="filter_info_div" style=" clear:both;"></div>
            <div id="apply_filter_div">
                <button id="clear_filter_button">Clear Filter</button>
                <button id="add_filter_button">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Create The Dashboard -->
<div class="container-fluid" style="z-index: 0; position: relative;">

    <!-- Create Chart Display Areas -->
    <div class="col-sm-12 main">
        <div class="row">
            <div class="col-sm-2" id="filter-section">
                <h4>Filter Section</h4>
                <table id="filters_table">
                </table>
            </div>
            <div class="col-sm-7" id="large-section">
                <h4>Large Section</h4>
            </div>
            <div class="col-sm-3">
                <h4>Player Data Table</h4>
                <table class="table table-striped table-borderedr" id="data_table">
                    <thead>
                    <tr class="header">
                        <th>Name</th>
                        <!--<th>Year</th>-->
                        <th>Fantasy Points</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>

        <div class="row">
            <div id="cdf_chart" class="col-sm-10">
                <svg></svg>
            </div>
        </div>
        <div class="row" style="display: none;">
            <div class="col-md-6" id="box-whisker-chart">
                <h4>Box and Whisker Plot</h4>
            </div>
            <div class="col-md-6" id="histogram">
                <h4>Histogram</h4>
            </div>
        </div>

    </div>
</div>

<script>

    //Global variable used to hold array list of filter objects
    var filterObjects = [];

    // Global variable mapping the pguid to player name
    // var PGUID_TO_NAME_MAP = {};
    var PGUID_TO_NAME_MAP = setupNameMap();

    //Variable to hold the state of the sliding menu
    var isMenuOpen = false;

    //Initialize the sliding drawer for the filters.
    $( "#menu-trigger" ).click( function ()
    {
        //If open -- close, if closed -- open
        if( isMenuOpen )
        {
            $( "#menu" ).css( {
                "display": "none"
            } );
        }
        else
        {
            $( "#menu" ).css( {
                "display": "block"
            } );
        }
        isMenuOpen = !isMenuOpen;
    } );

    var yearFormat = d3.time.format( '%Y' );

    var data_table;
    var data = [];

    var box_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var box_width = 500// - box_margin.left - box_margin.right;
    var box_height = 150// - box_margin.top - box_margin.bottom;
    var box_chart = dc.boxPlot( "#box-whisker-chart" );

    var scatter_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var scatter_width = 1000 - scatter_margin.right - scatter_margin.left;
    var scatter_height = 500 - scatter_margin.top - scatter_margin.bottom;
    // var scatter_chart = dc.scatterPlot( "#large-section" );

    var hist_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var hist_width = 500;
    var hist_height = 150;
    var hist_chart = dc.barChart( "#histogram" );

    // var tooltip = d3.select("body").append("div")
    //     .attr("class", "tooltip")
    //     .style("opacity", 1e-6)
    //     .style("background", "rgba(250,250,250,.7)");

    // tooltip.append("img")
    // 	.attr("id", "tooltipImg")
    // 	.attr("height", 200)
    // 	.attr("width", 200)
    // 	.style("opacity", "1");

    // Set the ranges
    var x = d3.scale.linear().range( [ 0, scatter_width ] );
    var y = d3.scale.linear().range( [ scatter_height, 0 ] );

    var colorScale = d3.scale.ordinal().domain( [ "QB", "RB", "WR", "TE" ] )
            .range( [ "red", "green", "blue", "gray" ] );

    // Define the axes
    var xAxis = d3.svg.axis().scale( x )
            .orient( "bottom" ).ticks( 6 );

    var yAxis = d3.svg.axis().scale( y )
            .orient( "left" ).ticks( 6 );

    // Define the div for the tooltip
    var div = d3.select( "body" ).append( "div" )
            .attr( "class", "tooltip" )
            .style( "opacity", 0 );

    // Adds the svg canvas
    var svg = d3.select( "#large-section" )
            .append( "svg" )
            .attr( "width", scatter_width + scatter_margin.left + scatter_margin.right )
            .attr( "height", scatter_height + scatter_margin.top + scatter_margin.bottom )
            .append( "g" )
            .attr( "transform",
            "translate(" + scatter_margin.left + "," + scatter_margin.top + ")" );

    // Lasso functions to execute while lassoing
    var lasso_start = function ()
    {
        lasso.items()
                .attr( "r", 3.5 ) // reset size
                .style( "fill", null ) // clear all of the fills
                .classed( { "not_possible": true, "selected": false } ); // style as not possible
    };

    var lasso_draw = function ()
    {
        // Style the possible dots
        lasso.items().filter( function ( d )
        {
            return d.possible === true
        } )
                .classed( { "not_possible": false, "possible": true } );

        // Style the not possible dot
        lasso.items().filter( function ( d )
        {
            return d.possible === false
        } )
                .classed( { "not_possible": true, "possible": false } );
    };

    var lasso_end = function ()
    {
        // Reset the color of all dots
        lasso.items()
                .style( "fill", function ( d )
                {
                    return colorScale( d.pos );
                } );

        // Style the selected dots
        lasso.items().filter( function ( d )
        {
            return d.selected === true
        } )
                .classed( { "not_possible": false, "possible": false } )
                .attr( "r", 7 );

        // Reset the style of the not selected dots
        lasso.items().filter( function ( d )
        {
            return d.selected === false
        } )
                .classed( { "not_possible": false, "possible": false } )
                .attr( "r", 3.5 );

        console.log( lasso.items().filter( function ( d )
        {
            return d.selected === true
        } ) );
        RefreshTable( lasso.items().filter( function ( d )
        {
            return d.selected === true
        } ) );
    };

    // Create the area where the lasso event can be triggered
    var lasso_area = svg.append( "rect" )
            .attr( "width", scatter_width )
            .attr( "height", scatter_height )
            .style( "opacity", 0 );

    // Define the lasso
    var lasso = d3.lasso()
            .closePathDistance( 75 ) // max distance for the lasso loop to be closed
            .closePathSelect( true ) // can items be selected by closing the path?
            .hoverSelect( true ) // can items by selected by hovering over them?
            .area( lasso_area ) // area where the lasso can be started
            .on( "start", lasso_start ) // lasso start function
            .on( "draw", lasso_draw ) // lasso draw function
            .on( "end", lasso_end ); // lasso end function

    // Init the lasso on the svg:g that contains the dots
    svg.call( lasso );

    //Add Default Filter
    var defaultFilterObject = new FilterObject( 2000, 2015, null, null, null );
    filterObjects.push( defaultFilterObject );

    //Draw the current filter table with the default filter applied.
    drawCurrentFilterTable();

    //Make a web call to get all of the pks for the default filter object
    $.ajax( {
        url: defaultFilterObject.generateCareerUrl(),
        type: 'GET',
        data: {
            format: 'json'
        },
        error: function ()
        {
            alert( "ERROR MAKING WEB REQUEST FOR PLAYER KEYS" )
        },
        success: function ( data )
        {
            //Get the result array
            data = data[ 'results' ];

            //Loop through the array and get all of the player pks
            $.each( data, function ( index, player )
            {
                defaultFilterObject.players.push( player[ 'pguid' ] );
            } );

            for ( var i = 0; i < 5; i++ )
            {
                $.ajax( {
                    url: defaultFilterObject.generateCareerUrl(),
                    type: 'GET',
                    data: {
                        format: 'json'
                    },
                    async: false,
                    error: function ()
                    {
                        alert( "ERROR MAKING WEB REQUEST FOR PLAYER KEYS" )
                    },
                    success: function ( data )
                    {
                        console.log( "test" );
                    }
                } );
            }

            console.log( "done" );

            //TODO load the rest of the page here. After the web call finishes
        }
    } );

    //Initial Ajax call to load data.
    $.ajax( {
        url: 'http://localhost:8000/careers/?pos=rb&pos=qb&start_year=2013',
        type: 'GET',
        data: {
            format: 'json'
        },
        error: function ()
        {
            console.log( "Error Loading Data." )
        },
        success: function ( data )
        {
            //Get the array of player data from the JSON response
            data = data[ 'results' ];

            data.forEach( function ( x )
            {
                x.short_year = x.start_year;
                x.year = yearFormat.parse( x.start_year + "" );
                x.name = x.player_name;
                x.pos = x.pos_type;
                x.fantPt = +x.ff_pts;
                x.winPct = d3.round( (+x.win_pct * 100), 2 );
            } );

            // Scale the range of the data
            x.domain( d3.extent( data, function ( d )
            {
                return d.winPct;
            } ) );
            y.domain( d3.extent( data, function ( d )
            {
                return d.fantPt;
            } ) );

            // Add the scatterplot
            svg.selectAll( "dot" )
                    .data( data )
                    .enter().append( "circle" )
                    .attr( "r", 3 )
                    .attr( "cx", function ( d )
                    {
                        return x( d.winPct );
                    } )
                    .attr( "cy", function ( d )
                    {
                        return y( d.fantPt );
                    } )
                    .attr( "id", function ( d, i )
                    {
                        return "dot_" + i;
                    } ) // added
                    .attr( "class", "dot" )
                    .style( "fill", function ( d )
                    {
                        return colorScale( d.pos );
                    } )
                    .on( "mouseover", function ( d )
                    {
                        d3.select( this )
                                .attr( "stroke", "black" )
                                .attr( "stroke-width", 1 )
                                .attr( "fill-opacity", 1 );
                        div.transition()
                                .duration( 200 )
                                .style( "opacity", .9 );
                        div.html( "Name: " + d.name + "<br/>" +
                                "Position: " + d.pos + "<br/>" +
                                "Fantasy Pts: " + d.fantPt + "<br/>" +
                                "Win %: " + d.winPct )
                                .style( "left", (d3.event.pageX + 5) + "px" )
                                .style( "top", (d3.event.pageY - 5) + "px" )
                                .transition().duration( 300 )
                                .style( "opacity", 1 )
                                .style( "display", "block" );
                    } )
                // .on("mouseover", function(d){
                // 	d3.select(this)
                // 		.attr("stroke", "black")
                // 		.attr("stroke-width", 1)
                // 		.attr("fill-opacity", 1)
                //       			})
                    .on( "mouseout", function ( d )
                    {
                        d3.select( this )
                                .attr( "stroke", "" )
                                .attr( "fill-opacity", function ( d )
                                {
                                    return 1;
                                } )

                        div.transition().duration( 700 ).style( "opacity", 0 );
                    } );

            // Add the X Axis
            svg.append( "g" )
                    .attr( "class", "x axis" )
                    .attr( "transform", "translate(0," + scatter_height + ")" )
                    .call( xAxis );

            // Add the Y Axis
            svg.append( "g" )
                    .attr( "class", "y axis" )
                    .call( yAxis );

            lasso.items( d3.selectAll( ".dot" ) );

            // var ndx = crossfilter( data );
            //
            // var box_dimension = ndx.dimension( function ( d )
            // {
            //     return new Date( new Date( d.year ).setDate( 1 ) );
            // } );
            // var box_group = box_dimension.group().reduce(
            //         function ( p, v )
            //         {
            //             p.push( v.fantPt );
            //             return p;
            //         },
            //         function ( p, v )
            //         {
            //             p.splice( p.indexOf( v.fantPt ), 1 );
            //             return p;
            //         },
            //         function ()
            //         {
            //             return [];
            //         }
            // );
            //
            // box_chart
            //         .width( box_width )
            //         .height( box_height )
            //         .margins( box_margin )
            //         .dimension( box_dimension )
            //         .group( box_group )
            //         .boxWidth( 3 )
            //         .colors( "red" )
            //         .x( d3.time.scale().domain( [ new Date( "1918" ), new Date( "2016" ) ] ) )
            //         .round( d3.time.year.round )
            //         .xUnits( d3.time.year )
            //         .yAxisLabel( "Fantasy Points" )
            //         .xAxisLabel( "Year" )
            //         .elasticY( true )
            //         .elasticX( true )
            //         .keyAccessor( function ( d )
            //         {
            //             return d.key;
            //         } )
            //         .valueAccessor( function ( d )
            //         {
            //             return d.value;
            //         } )
            //         .on( "renderlet", function ( box_chart )
            //         {
            //
            //             var gBoxLabels = box_chart.selectAll( "text.box" );
            //             var gWhiskLabels = box_chart.selectAll( "text.whisker" );
            //             gBoxLabels.remove();
            //             gWhiskLabels.remove();
            //
            //         } );

            // var scatterDimension = ndx.dimension( function ( d )
            // {
            //     return [ d.winPct, d.fantPt ];
            // } );
            // var scatterGroup = scatterDimension.group();
            //
            // scatter_chart
            //         .width( scatter_width )
            //         .height( scatter_height )
            //         .margins( scatter_margin )
            //         .symbolSize( 8 )
            //         .clipPadding( 10 )
            //         .mouseZoomable( true )
            //         .x( d3.scale.linear().domain( [ 0, 100 ] ) )
            //         .dimension( scatterDimension )
            //         .group( scatterGroup )
            //     //.brushOn( false )
            //         .renderTitle( true )
            //         .title( function ( p )
            //         {
            //             return
            //             d.name;
            //         } )
            //         .yAxisLabel( "Fantasy Points" )
            //         .xAxisLabel( "Win Percentage" )
            //         .xAxisPadding( 10 );

            // var histDimension = ndx.dimension( function ( d )
            // {
            //     return d.fantPt;
            // } );
            // var histGroup = histDimension.group().reduceCount();
            //
            // hist_chart
            //         .width( hist_width )
            //         .height( hist_height )
            //         .margins( hist_margin )
            //         .x( d3.scale.linear().domain( [ 0, 2550 ] ) )
            //         .dimension( histDimension )
            //         .group( histGroup )
            //         .yAxisLabel( "Number of Players" )
            //         .xAxisLabel( "Fantasy Points" );
            //
            // var table_dimension = ndx.dimension( function ( d )
            // {
            //     return d.name;
            // } );
            // $(document).ready(function() {
            //     $('#data_table').DataTable( {
            //         data: lasso.items().filter(function(d) {return d.selected===true}),
            //         columns: [
            //             { title: "Name" },
            //             { title: "Position" },
            //             { title: "Office" },
            //             { title: "Extn." },
            //             { title: "Start date" },
            //             { title: "Salary" }
            //         ]
            //     } );
            // } );
            data_table = $( "#data_table" ).dataTable( {
                "bPaginate": true,
                "pagingType": "full_numbers",
                "bLengthChange": false,
                "bFilter": false,
                "bSort": true,
                "bInfo": false,
                "bAutoWidth": false,
                "bDeferRender": true,
                "aaData": lasso.items().filter( function ( d )
                {
                    return d.selected === true
                } ),
                "bDestroy": true,
                "aoColumns": [
                    { "mData": "name", "sDefaultContent": "" },
                    { "mData": "short_year", "sDefaultContent": " " },
                    { "mData": "fantPt", "sDefaultContent": " " }
                ]
            } );
//          { "mData": "short_year", "sDefaultContent": " " },

            // for ( var i = 0; i < dc.chartRegistry.list().length; i++ )
            // {
            //     var chartI = dc.chartRegistry.list()[ i ];
            //     chartI.on( "filtered", RefreshTable );
            // }

            // dc.renderAll();
        }
    } );

    drawSelectionFilter();
    generateCDFChart();
    function RefreshTable( alldata )
    {
        data_table.fnClearTable();
        data_table.fnAddData( alldata );
        data_table.fnDraw();
    }
    function callScatterPlot()
    {
        // // Set the dimensions of the canvas / graph
        // var margin = {top: 30, right: 20, bottom: 30, left: 50},
        //     width = 1000 - margin.left - margin.right,
        //     height = 500 - margin.top - margin.bottom;
        //
        // // Set the ranges
        // var x = d3.scale.linear().range([0, width]);
        // var y = d3.scale.linear().range([height, 0]);
        //
        // // Define the axes
        // var xAxis = d3.svg.axis().scale(x)
        //     .orient("bottom").ticks(6);
        //
        // var yAxis = d3.svg.axis().scale(y)
        //     .orient("left").ticks(6);
        //
        // // Define the div for the tooltip
        // var div = d3.select("body").append("div")
        //     .attr("class", "tooltip")
        //     .style("opacity", 0);
        //
        // // Adds the svg canvas
        // var svg = d3.select("#large-section")
        //     .append("svg")
        //         .attr("width", width + margin.left + margin.right)
        //         .attr("height", height + margin.top + margin.bottom)
        //     .append("g")
        //         .attr("transform",
        //               "translate(" + margin.left + "," + margin.top + ")");
        //
        //     // Scale the range of the data
        //     x.domain(d3.extent(data, function(d) { return d.winPct; }));
        //     y.domain(d3.extent(data, function(d) { return d.fantPt; }));
        //
        //     // Add the scatterplot
        //     svg.selectAll("dot")
        //         .data(data)
        //     .enter().append("circle")
        //         .attr("r", 5)
        //         .attr("cx", function(d) { return x(d.winPct); })
        //         .attr("cy", function(d) { return y(d.fantPt); })
        //         .on("mouseover", function(d) {
        //             div.transition()
        //                 .duration(200)
        //                 .style("opacity", .9);
        //             div	.html("Name: " + d.name + "<br/>"  +
        //                       "Position: " + d.pos + "<br/>" +
        //                       "Fantasy Pts: " + d.fantPt + "<br/>" +
        //                       "Win %: " + d.winPct)
        //                 .style("left", (d3.event.pageX) + "px")
        //                 .style("top", (d3.event.pageY - 28) + "px");
        //             })
        //         .on("mouseout", function(d) {
        //             div.transition()
        //                 .duration(500)
        //                 .style("opacity", 0);
        //         });
        //
        //     // Add the X Axis
        //     svg.append("g")
        //         .attr("class", "x axis")
        //         .attr("transform", "translate(0," + height + ")")
        //         .call(xAxis);
        //
        //     // Add the Y Axis
        //     svg.append("g")
        //         .attr("class", "y axis")
        //         .call(yAxis);

    }

    // To be used by tooltips when you want the playername
    function setupNameMap()
    {
        var nameMap = {};
        d3.json( 'http://localhost:8000/careers', function ( error, data )
        {
            // console.log(data);
            data[ 'results' ].forEach( function ( career )
            {
                if( nameMap[ career[ 'pguid' ] ] === undefined )
                {
                    nameMap[ career[ 'pguid' ] ] = career[ 'player_name' ];
                }
            } );
            // console.log(nameMap);
            return nameMap;
        } );
    }

    /**
     * Returns an array with all of the unique player primary keys from the filtered objects.
     */
    function loadScatterPlot()
    {

    }

    /**
     * Returns an array with all of the unique player primary keys from the filtered objects.
     */
    function filteredPlayers()
    {
        //Create the set to place the pks
        var playerSet = new Set();

        //Loop through all of the filter objects
        $.each( filterObjects, function ( index, filterObject )
        {
            //Get the filter objects player pk array
            var pks = filterObject.players;

            //Loop through all of the player pks and add to set.
            $.each( pks, function ( index2, pk )
            {
                playerSet.add( pk );
            } );

        } );

        //return an array containing all of the unigue player pks
        return Array.from( playerSet );
    }
</script>

</body>
</html>
