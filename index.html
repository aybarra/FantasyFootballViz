<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Fantasy Football Test</title>

    <script src="d3/d3.js"></script>
    <script src="crossfilter/crossfilter.min.js" type="text/javascript"></script>
    <script src="dc/dc.min.js" type="text/javascript"></script>
    <script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="lib/DataTables/datatables.min.js" type="text/javascript"></script>
    <script src="js/filter_grouping.js"></script>
    <script src="js/player_grouping.js"></script>
    <script src="js/helper/filter_helper.js"></script>
    <script src="js/helper/menu_helper.js"></script>
    <script src="js/model/FilterObject.js"></script>
    <script src="js/lasso.js"></script>
    <script src="js/d3.parcoords.js"></script>
    <script src="js/pcplot.js"></script>
    <script src="lib/AutoComplete/dist/jquery.autocomplete.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/mathjs/2.4.2/math.min.js"></script>


    <!-- <link href="nvd3/build/nv.d3.min.css" rel="stylesheet">
    <script src="nvd3/build/nv.d3.min.js"></script>
    <script src="nvd3/src/tooltip.js"></script>
    <script src="nvd3/src/utils.js"></script>
    <script src="nvd3/src/models/legend.js"></script>
    <script src="nvd3/src/models/axis.js"></script>
    <script src="nvd3/src/models/distribution.js"></script>
    <script src="nvd3/src/models/scatter.js"></script>
    <script src="nvd3/src/models/scatterChart.js"></script>
    <link href="nvd3/build/nv.d3.min.css" rel="stylesheet"> -->
    <script src="js/cdf_d3.js"></script>
    <script src="js/seasonal_line.js"></script>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="css/cdf.css" rel="stylesheet">
    <!-- <link href="dc/dc.css" rel="stylesheet" type="text/css">
    <link href="css/dashboard.css" rel="stylesheet"> -->
    <link href="css/layout.css" rel="stylesheet">
    <link href="css/d3.parcoords.css" rel="stylesheet">
    <link href="css/pcplot.css" rel="stylesheet">
    <link href="lib/DataTables/datatables.min.css" rel="stylesheet">
    <link href="lib/AutoComplete/content/styles.css" rel="stylesheet">

</head>

<body>

<!-- Create Navigation Bar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid ">
        <div id="navbar">
            <!-- <img src="images/logo.jpg"></scr> -->
            <a class="navbar-brand" id="menu-trigger"
               style="cursor:pointer; -webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;">Filter</a>

            <p class="navbar-brand nav navbar-nav navbar-right" id="title">Armchair Fantasy Football</p>

        </div>
    </div>
</nav>

<!--Sliding Menu-->
<div id="menu"
     style="width: 600px; z-index: 1; display: none; position:fixed; background-color: #E8E8E8; height: 100%; padding-left: 20px">
    <div class="row" id="panel">
        <div id="filters">
            <!-- Year Chart DIV-->
            <div class="col-md-10" id="filter_years">
                <h4>Year Range</h4>
            </div>
            <!-- Date Chart DIV-->
            <div class="col-md-10" id="filter_dates" style=" clear:both;">
                <h4>Point Range</h4>
            </div>
            <!-- Checkbox DIV-->
            <div class="col-md-10" id="filter_position" style=" clear:both;">
                <h4>Positions</h4>
                <label>
                    <input type=checkbox name="running_back" value="running_back" id="filter_running_back"/>
                    Running Back
                </label>
                <label>
                    <input type=checkbox name="quarter_back" value="quarter_back" id="filter_quarter_back"/>
                    Quarter Back
                </label>
                <label>
                    <input type=checkbox name="wr" value="wr" id="filter_wr"/>
                    WR
                </label>
                <label>
                    <input type=checkbox name="te" value="te" id="filter_te"/>
                    TE
                </label>
            </div>
            <div class="col-md-10" id="filter_active_inactive" style="clear:both;">
                <h4>Player Status</h4>
                <label>
                    <input type=checkbox name="active" value="active" id="filter_active"/>
                    Active
                </label>
                <label>
                    <input type=checkbox name="inactive" value="inactive" id="filter_inactive"/>
                    Inactive
                </label>
            </div>
            <div id="filter_info_div" style=" clear:both;"></div>
            <div id="apply_filter_div">
                <button id="clear_filter_button">Clear Filter</button>
                <button id="add_filter_button">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Create The Dashboard -->
<div class="container-fluid" style="z-index: 0; position: relative;">

    <!-- Create Chart Display Areas -->
    <div class="col-sm-12 main">
        <div class="row">
            <div class="col-sm-2" id="filter-section">
                <h4>Filter Section</h4>
                <table id="filters_table">
                </table>
                <h4>Add Player</h4>
                <input type="text" name="add_player_input_field" id="add_player_input_field"/>

                <div class="autocomplete-suggestions" id="autocomplete_results_div">
                    <div class="autocomplete-group" id="autocomplete_group"><strong>Added Players</strong></div>
                    <!--<div class="autocomplete-suggestion autocomplete-selected">...</div>-->
                    <!--<div class="autocomplete-suggestion">...</div>-->
                    <!--<div class="autocomplete-suggestion">...</div>-->
                </div>
            </div>
            <div class="col-sm-8">
                <div class="row">
                  <div class="btn-group" data-toggle="buttons-radio">
                    <button type="button" id="career" class="btn active switch btn-primary btn-xs" onclick="transitionTo('career')">Career View</button>
                    <button type="button" id="seasonal" class="btn switch btn-primary btn-xs" onclick="transitionTo('seasonal')">Player Comparison</button>
                    <!-- <button type="button" id="area" class="btn switch">Area</button> -->
                  </div>
                </div>
                  <div class="row">
                    <div class="col-sm-12 career_chart chart" id="scatter_chart"></div>
                </div>

                <div class="row">
                    <div class="col-sm-12 career_chart chart">
                        <button type="button" id="cdf_year_swap" class="btn-primary btn-xs">CHANGE AXIS</button>
                        <div id="cdf_chart"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12 seasonal_chart chart" id="seasonal_line" style="display: none"></div>
                </div>


                <div class="row">
                  <div class="col-sm-8 seasonal_chart chart" style="display: none">
                    <div class="btn-group" data-toggle="buttons-radio">
                      <button type="button" id="average" class="btn active switch btn-primary btn-xs">Average</button>
                      <button type="button" id="good" class="btn switch btn-primary btn-xs" >Good</button>
                      <button type="button" id="elite" class="btn switch btn-primary btn-xs" >Elite</button>
                    </div>
                  </div>
                  <div class = "col-sm-4 seasonal_chart chart" style="display: none">
                    <button type="button" id="year" class="btn-primary btn-xs">Year</button>
                  </div>
                </div>

                <div class="row">
                    <div id="pcplot" class="parcoords col-sm-12 seasonal_chart chart" style="display:none" ></div>
                </div>

            </div>

            <div class="col-sm-2">
                <h4>Player Data Table</h4>
                <table class="table table-row-border table-hover" id="data_table" width="100%">
                    <thead>
                    <tr class="header">
                        <th>Name</th>
                        <th>Pos</th>
                        <th>Pts</th>
                        <th>Win %</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>

<script>


    // $(document).ready(function() {
    //   setTimeout(function(){
    //     document.getElementById("career").click();
    //   },1500);
    // });
    //Global variable used to hold array list of filter objects
    var filterObjects = [];

    //Global variable used to hold array of extra player objects used for filtering
    var selectedPlayers = [];

    // Global variable mapping the pguid to player name
    // var PGUID_TO_NAME_MAP = {};
    var PGUID_TO_NAME_MAP = {};
    var dispatch = d3.dispatch("lasso_seasonal", "lasso_cdf");

    var yearFormat = d3.time.format( '%Y' );

    var data_table;

    var data = [];
    var lassoed_items = [];

    //CONSTANTS
    var scatter_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var scatter_width = 900 - scatter_margin.right - scatter_margin.left;
    var scatter_height = 400 - scatter_margin.top - scatter_margin.bottom;
    var scatter_padding = 100;

    var cdf_margin = { top: 10, right: 30, bottom: 33, left: 45 };
    var cdf_width = 900 - cdf_margin.right - cdf_margin.left;
    var cdf_height = 400 - cdf_margin.top - cdf_margin.bottom;

    var swap_sound = new Audio('sounds/whip_crack.mp3');

    var dot_init_size = 3;
    var dot_hover_size = 7;
    var dot_trans = 300;
    var tooltip_trans_in = 200;
    var tooltip_trans_out = 400;

    var colorScale = //d3.scale.ordinal().domain( [ "QB", "RB", "WR", "TE" ] )
        //.range( [ "red", "green", "blue", "gray" ] );
            d3.scale.category10();

    // Adds the svg canvas
    var svg_scatter = d3.select( "#scatter_chart" )
            .append( "svg" )
            .attr( "width", scatter_width + scatter_margin.left + scatter_margin.right )
            .attr( "height", scatter_height + scatter_margin.top + scatter_margin.bottom )
            .append( "g" )
            .attr( "transform",
            "translate(" + scatter_margin.left + "," + scatter_margin.top + ")" );

    // // Set the ranges
    // var x = d3.scale.linear().range( [ 0, scatter_width ] );
    // var y = d3.scale.linear().range( [ scatter_height, 0 ] );
    //
    //
    //
    // // Define the axes
    // var xAxis = d3.svg.axis().scale( x )
    //         .orient( "bottom" ).ticks( 6 );
    //
    // var yAxis = d3.svg.axis().scale( y )
    //         .orient( "left" ).ticks( 10 );
    //
    //
    //
    // var scat_xaxis_padding = 0;
    // var scat_yaxis_padding = 0;

    // Define the div for the tooltip
    var tooltip = d3.select( "body" ).append( "div" )
            .attr( "class", "tooltip" )
            .style( "opacity", 0 )//1e-6)
            .style( "background", "rgba(250,250,250,.9)" );

    tooltip.append( "img" )
            .attr( "id", "tooltipImg" )
            .attr( "height", 100 )
            .attr( "width", 100 )
            .style( "opacity", "1" );

    var printDetails = [
        { 'var': 'name', 'print': 'Name' },
        { 'var': 'pos_long', 'print': 'Position' },
        { 'var': 'fantPt', 'print': 'Fantasy Pts' },
        { 'var': 'winPct', 'print': 'Win %' } ];

    // Lasso functions to execute while lassoing
    var lasso_start = function ()
    {
        lasso.items()
                .attr( "r", dot_init_size ) // reset size
                .style( "fill", null ) // clear all of the fills
                .classed( { "not_possible": true, "selected": false } ); // style as not possible
    };

    var lasso_draw = function ()
    {
        // Style the possible dots
        lasso.items().filter( function ( d )
        {
            return d.possible === true
        } )
                .classed( { "not_possible": false, "possible": true } );

        // Style the not possible dot
        lasso.items().filter( function ( d )
        {
            return d.possible === false
        } )
                .classed( { "not_possible": true, "possible": false } );
    };

    var lasso_end = function ()
    {
        // Reset the color of all dots
        lasso.items()
                .style( "fill", function ( d )
                {
                    return colorScale( d.pos );
                } );

        // Style the selected dots
        lasso.items().filter( function ( d )
        {
            return d.selected === true
        } )
                .classed( { "not_possible": false, "possible": false } )
                .transition().duration(dot_trans)
                .attr( "r", dot_hover_size );

        // Reset the style of the not selected dots
        lasso.items().filter( function ( d )
        {
            return d.selected === false
        } )
                .classed( { "not_possible": false, "possible": false } )
                .attr( "r", dot_init_size );

        //Update array holding lassoed items
        lassoed_items = lasso.items().filter( function ( d )
        {
            return d.selected === true
        } ).data();

        // console.log(lassoed_items);

        dispatch.lasso_cdf( lassoed_items );
        dispatch.lasso_seasonal( lassoed_items );
        refreshPlayerDataTable( lassoed_items );

    };

    // Create the area where the lasso event can be triggered
    var lasso_area = svg_scatter.append( "rect" )
            .attr( "width", scatter_width )
            .attr( "height", scatter_height )
            .style( "opacity", 0 );

    // Define the lasso
    var lasso = d3.lasso()
            .closePathDistance( 75 ) // max distance for the lasso loop to be closed
            .closePathSelect( true ) // can items be selected by closing the path?
            .hoverSelect( true ) // can items by selected by hovering over them?
            .area( lasso_area ) // area where the lasso can be started
            .on( "start", lasso_start ) // lasso start function
            .on( "draw", lasso_draw ) // lasso draw function
            .on( "end", lasso_end ); // lasso end function

    // // Init the lasso on the svg:g that contains the dots
    // svg_scatter.call( lasso );

    //Add Default Filter
    var defaultFilterObject = new FilterObject( 2010, 2015, 100, 10000, null, [ 2 ] );
    filterObjects.push( defaultFilterObject );

    //Draw the current filter table with the default filter applied.
    drawCurrentFilterTable();

    //Make a web call to get all of the pks for the default filter object
    $.ajax( {
        url: defaultFilterObject.generateCareerUrl(),
        type: 'GET',
        data: {
            format: 'json'
        },
        error: function ()
        {
            alert( "ERROR MAKING WEB REQUEST FOR PLAYER KEYS" )
        },
        success: function ( data )
        {
            //Get the result array
            data = data[ 'results' ];

            //Loop through the array and get all of the player pks
            $.each( data, function ( index, player )
            {
                defaultFilterObject.players.push( player );
            } );


            setupNameMap();
            loadScatterPlot();
            createTable();
            drawPCChart();

        }
    } );

    //Initial calls to load data and setup page.
    drawSelectionFilter();
    // generateCDFChart();

    generateLineChart();
    
    /**
     * To be used by tooltips when you want the playername
     */
    function setupNameMap()
    {
        d3.json( 'http://localhost:8000/careers', function ( error, data )
        {
          // console.log(data);
          data['results'].forEach( function ( career )
          {
              if( PGUID_TO_NAME_MAP[ career[ 'pguid' ] ] === undefined ) {
                  PGUID_TO_NAME_MAP[ career[ 'pguid' ] ] = new Array(2);
                  PGUID_TO_NAME_MAP[ career[ 'pguid' ] ][0] = career[ 'player_name' ];
                  PGUID_TO_NAME_MAP[ career[ 'pguid' ] ][1] = career[ 'pos_type'];
              }
          });

          generateCDF_D3Chart();
          // animateLines();
        });
    }

    /**
     *
     */
    function loadScatterPlot()
    {
        //TODO call this after adding more filters
        //TODO call this when deleting filters
        //TODO clear out old charts and graphs.
        var playerArray = filteredPlayers();

        playerArray.forEach( function ( x )
        {
            x.short_year = x.start_year;
            x.year = yearFormat.parse( x.start_year + "" );
            x.name = x.player_name;
            x.pos = x.pos_type;
            {
                if( x.pos == "qb" )
                {
                    x.pos_long = "QB"
                }
                else if( x.pos == "rb" )
                {
                    x.pos_long = "RB"
                }
                else if( x.pos == "wr" )
                {
                    x.pos_long = "WR"
                }
                else if( x.pos == "te" )
                {
                    x.pos_long = "TE"
                }
                else
                {
                    x.pos == ""
                }
            }
            ;
            x.fantPt = +x.ff_pts;
            x.winPct = d3.round( (+x.win_pct * 100), 2 );
        } );

        // Set the ranges
        var x = d3.scale.linear().range( [ 0, scatter_width ] );
        var y = d3.scale.linear().range( [ scatter_height, 0 ] );



        // Define the axes
        var xAxis = d3.svg.axis().scale( x )
                .orient( "bottom" ).ticks( 6 );

        var yAxis = d3.svg.axis().scale( y )
                .orient( "left" ).ticks( 10 );



        var scat_xaxis_padding = 0;
        var scat_yaxis_padding = 0;

        // Scale the domain of the data
        var xmin = d3.min( playerArray, function ( d )
                        {
                            return d.winPct;
                        } ) - scat_xaxis_padding,
                xmax = d3.max( playerArray, function ( d )
                        {
                            return d.winPct;
                        } ) + scat_xaxis_padding,
                ymin = d3.min( playerArray, function ( d )
                        {
                            return d.fantPt;
                        } ) - scat_yaxis_padding,
                ymax = d3.max( playerArray, function ( d )
                        {
                            return d.fantPt;
                        } ) + scat_yaxis_padding;

        // x.domain( d3.extent( playerArray, function ( d )
        // {
        //     return d.winPct;
        // } ) );
        // y.domain( d3.extent( playerArray, function ( d )
        // {
        //     return d.fantPt;
        // } ) );

        x.domain( [ xmin, xmax ] );
        // x.domain( [ 0,100 ] );

        y.domain( [ ymin, ymax ] );

        // Add the scatterplot
        svg_scatter.selectAll( "dot" )
                .data( playerArray )
                .enter().append( "circle" )
                .attr( "r", dot_init_size )
                .attr( "cx", function ( d )
                {
                    return x( d.winPct );
                } )
                .attr( "cy", function ( d )
                {
                    return y( d.fantPt );
                } )
                .attr( "id", function ( d, i )
                {
                    return "dot_" + i;
                } ) // added
                .attr( "class", "dot" )
                .style( "fill", function ( d )
                {
                  return colorScale( d.pos );
                } )
                .attr( "stroke", "black" )
                .attr( "stroke-width", 1 )
                .attr("fill-opacity", 0.7)
                .on( "click", function ( d )
                {
                    refreshPlayerDataTable( d );
                } )
                .on( "mouseover", function ( d )
                {
                    d3.select( this )
                            .transition().duration(dot_trans)
                            .attr( "stroke", "black" )
                            .attr( "stroke-width", 2 )
                            .attr( "r", dot_hover_size )
                            .attr( "fill-opacity", 1 );
                    tooltip
                            .style( "left", (d3.event.pageX + 5) + "px" )
                            .style( "top", (d3.event.pageY - 5) + "px" )
                            .transition().duration( tooltip_trans_in )
                            .style( "opacity", 1 )
                            .style( "display", "block" )
                    // tooltip.html( "Name: " + d.name + "<br/>" +
                    //         "Position: " + d.pos + "<br/>" +
                    //         "Fantasy Pts: " + d.fantPt + "<br/>" +
                    //         "Win %: " + d.winPct )
                    //         .style( "left", (d3.event.pageX + 5) + "px" )
                    //         .style( "top", (d3.event.pageY - 5) + "px" )
                    //         .transition().duration( 300 )
                    //         .style( "opacity", 1 )
                    //         .style( "display", "block" );
                    updateDetails( d );
                } )
                .on( "mouseout", function ( d )
                {
                    d3.select( this )
                            .transition().duration(dot_trans)
                            .attr( "stroke", "black" )
                            .attr( "stroke-width", 1 )
                            .attr( "r", function ( d )
                            {
                                if( d.selected == false )
                                {
                                    return dot_init_size;
                                }
                                else
                                {
                                    return dot_hover_size;
                                }
                            } )
                            .attr( "fill-opacity", function ( d )
                            {
                                return .7;
                            } )

                    tooltip.transition().duration( tooltip_trans_out ).style( "opacity", 0 );
                } );

        // Add the X Axis
        svg_scatter.append( "g" )
                .attr( "class", "x axis" )
                .attr( "transform", "translate(0," + scatter_height + ")" )
                .call( xAxis )
                .append("text")
                .attr("text-anchor", "middle")
                .attr("transform", "translate("+ (scatter_width/2) +","+(scatter_height)+")")
                .text("Win Percentage");

        // Add the Y Axis
        svg_scatter.append( "g" )
                .attr( "class", "y axis" )
                .call( yAxis )
                .append("text")
                .attr("text-anchor", "middle")
                .attr("transform", "translate("+ 10 +","+(scatter_height/2)+")rotate(-90)")
                .text("Fantasy Points");

                // Init the lasso on the svg:g that contains the dots
                svg_scatter.call( lasso );

        lasso.items( d3.selectAll( ".dot" ) );

    }

    function createTable()
    {

        $( document ).ready( function ()
        {

            data_table = $( "#data_table" ).DataTable( {
                select: true,
                fixedColumns: {
                  heightMatch: 'none'
                },
                data: lassoed_items,
                columns: [
                    { data: "name" },
                    { data: "pos_long" },
                    { data: "fantPt" },
                    { data: "winPct" }
                ],
                dom:  'Bfrtip',
                buttons: [
                  'selected',
                  'selectAll',
                  'selectNone',
                  'selectRows'
                ]
            } );

            // $('#data_table tbody').on( 'click', 'tr', function () {
            //   $(this).toggleClass('selected');
            // } );

        } );

        // $('#example tbody').on( 'click', 'tr', function () {
        //   $(this).toggleClass('selected');
        // } );

        // data_table = $( "#data_table" ).dataTable( {
        //     "bPaginate": true,
        //     "pagingType": "full_numbers",
        //     "bLengthChange": false,
        //     // "bFilter": false,
        //     "bSort": true,
        //     // "bInfo": false,
        //     "bAutoWidth": false,
        //     // "bDeferRender": true,
        //     "aoData": "lassoed_items",
        //     // "bDestroy": true,
        //     "aoColumns": [
        //         { "mData": "name",
        //           "defaultContent": "<i>Empty</i>"},
        //         { "mData": "pos_long",
        //       "defaultContent": "<i>Empty</i>"},
        //
        //         { "mData": "fantPt",
        //       "defaultContent": "<i>Empty</i>"},
        //         { "mData": "winPct",
        //       "defaultContent": "<i>Empty</i>"}
        //
        //   ]
        //
        // } );
    }

    function updateDetails( player )
    {
        var image = new Image();
        image.onload = function ()
        {
          document.getElementById( "tooltipImg" ).src = 'player_pics/' + player.pguid + '.jpg';
          // image.src = 'player_pics/' + player.pguid + '.jpg';

        }
        image.onerror = function(){
          document.getElementById( "tooltipImg" ).src = 'images/' + player.pos + '.jpg';
          // image.src = 'images/' + player.pos + '.jpg';

        }
        // image.src = 'images/' + player.pos + '.jpg';
        image.src = 'player_pics/' + player.pguid + '.jpg';

        tooltip.selectAll( "div" ).remove();
        tooltip.selectAll( "div" ).data( printDetails ).enter()
                .append( "div" )
                .append( 'span' )
                .text( function ( d )
                {
                    return d.print + ": ";
                } )
                .attr( "class", "boldDetail" )
                .insert( 'span' )
                .text( function ( d )
                {
                    return player[ d.var ];
                } )
                .attr( "class", "normalDetail" );
    }

    /**
     *
     */
    function refreshPlayerDataTable( alldata )
    {
        data_table.clear();
        data_table.rows.add( alldata );
        data_table.draw();
    }

    function transitionTo(name){
      var x = document.getElementsByClassName("career_chart");
      var y = document.getElementsByClassName("seasonal_chart");
      // swap_sound.play();
      if (name == "seasonal"){
        // if ($("#cdf_chart").has("svg").length==0){
        //   console.log("calling cdf chart");
        //   generateCDF_D3Chart();
        // }
        // document.getElementById('scatter_chart').style.display = 'none';
        // document.getElementById('cdf_chart').style.display = 'none';
        // document.getElementById('seasonal_line').style.display = 'block';
        for (var i =0; i < x.length; i++){
            x[i].style.display = "none";
          }

          for (var i =0; i < y.length; i++){
              y[i].style.display = "block";
            }

          document.getElementById("pcplot").style.display = 'block';
       };

      if (name == "career"){
        // d3.select("#cdf_chart").select("svg").remove();

        // document.getElementById('scatter_chart').style.display = 'block';
        // document.getElementById('cdf_chart').style.display = 'block';
        // document.getElementById('seasonal_line').style.display = 'none';

        for (i =0; i < y.length; i++){
            y[i].style.display = "none";
          }

          for (i =0; i < x.length; i++){
              x[i].style.display = "block";
            }
      }

    }

</script>

</body>
</html>
